{
  "hash": "4cda2c522155bed108095ba4b407075d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Quick Simulated Example with LBCNet\"\n---\n\n## Purpose of This Example\nThis example demonstrates how to apply LBCNet on a simulated dataset inspired by the misspecified propensity score model from Kang & Schafer (2007). Our goal is to estimate the mean outcome, assess covariate balance, and evaluate propensity score calibration using local system Python.\n\n## Simulate the Data\nWe simulate data where the true propensity score model differs from the one used in the analysis, representing a challenging scenario for causal inference (misspecified propensity score model).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(MASS)\n\n# Set seed for reproducibility\nset.seed(123456)\n\n# Define sample size\nn <- 5000\n\n# Generate true covariates from a multivariate normal distribution\nZ <- MASS::mvrnorm(n, mu = rep(0, 4), Sigma = diag(4))\n\n# Generate true propensity scores\nprop <- 1 / (1 + exp(Z[,1] - 0.5 * Z[,2] + 0.25 * Z[,3] + 0.1 * Z[,4]))\n\n# Assign treatment based on propensity scores\nTr <- rbinom(n, 1, prop)\n\n# Generate continuous outcome (correct model)\nY <- 210 + 27.4 * Z[,1] + 13.7 * Z[,2] + 13.7 * Z[,3] + 13.7 * Z[,4] + rnorm(n)\n\n# Create a set of covariates for estimation (misspecified model)\nX <- cbind(\n  exp(Z[,1] / 2),\n  Z[,2] * (1 + exp(Z[,1]))^(-1) + 10,\n  ((Z[,1] * Z[,3]) / 25 + 0.6)^3,\n  (Z[,2] + Z[,4] + 20)^2\n)\n\n# Combine data into a data frame\ndata <- data.frame(Y, Tr, X)\ncolnames(data) <- c(\"Y\", \"Tr\", \"X1\", \"X2\", \"X3\", \"X4\")\n\n# Quick look at the data\nhead(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Y Tr        X1        X2        X3       X4\n1 267.0934  1 2.0995290 10.136751 0.1936739 465.4067\n2 211.1973  1 1.0944490 10.811059 0.2031783 462.5301\n3 190.5548  1 1.1113093  9.313208 0.2168326 327.9726\n4 209.1748  1 0.9292040 10.001453 0.2145796 403.6159\n5 198.9068  1 0.4234368 10.261615 0.2123729 508.9887\n6 235.8486  0 0.7080015 11.445936 0.2109414 529.2390\n```\n\n\n:::\n:::\n\n\n## Set Up Python Environment Using a Virtual Environment\nIn this example, we set up LBCNet to run in a Python virtual environment called `\"r-lbcnet\"`.  \nUsing a virtual environment ensures the Python packages needed for LBCNet are installed and isolated from other projects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(LBCNet)\n\n# Set up LBCNet to use a virtual environment named \"r-lbcnet\"\nsetup_lbcnet(\n  envname = \"r-lbcnet\",       # Name of the virtual environment\n  create_if_missing = TRUE   # Set to TRUE if you want LBCNet to create the environment automatically if it doesn't exist\n)\n```\n:::\n\n\nHere, `envname = \"r-lbcnet\"` specifies the name of the Python virtual environment and `create_if_missing = FALSE` means LBCNet will automatically create a new virtual environment and install the necessary Python dependencies (like torch) if it doesn't already exist.  \n\n## Fit the LBC-Net Model\nEstimate propensity scores using LBC-Net with the covariates `X1`, `X2`, `X3`, `X4`, and then compute the causal estimator (Inverse Probability Weighting estimator) of ATE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the LBC-Net model\nlbc_net.fit <- lbc_net(\n  data = data,\n  formula = Tr ~ X1 + X2 + X3 + X4,\n  Y = data$Y,\n  estimand = \"ATE\"\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPython is already set up. Skipping `setup_lbcnet()`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCalculating propensity scores for ck/h calculation...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n⚠️ Stopping criterion not met at max epochs. Try increasing `max_epochs` or adjusting `lsd_threshold` for better convergence.\nStarting post-processing: computing treatment effect and variance...\n✅ LBC-Net training completed successfully.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Print the model fit object\nprint(lbc_net.fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall: Tr ~ X1 + X2 + X3 + X4 \nSample Size: 5000  | Treated: 2466  | Control: 2534 \nEstimand: ATE (Average Treatment Effect) \n\n--- Training Results ---\nFinal Loss Value: 840.804 \nMax LSD: 3.92% \nMean LSD: 0.40% \n\n--- Model Hyperparameters ---\nHidden Layers: 1 | Hidden Units: 100\nVAE Learning Rate: 0.010 | LBC-Net Learning Rate: 0.050\nWeight Decay: 1.0e-05 | Balance Lambda: 1.00\nKernel: \"gaussian\" \n\n--- Stopping Criteria ---\nLSD Threshold: 2.00% | Rolling Window: 5\nMax Training Epochs: 5000\n\n--- Treatment Effect (stored in object) ---\nEstimand: ATE (Average Treatment Effect)\nEffect:   -3.3174\nSE:       0.4207\n95% CI:   [-4.1419, -2.4928]\n\nUse summary(object) for a full model summary.\n```\n\n\n:::\n:::\n\n\n## Evaluate Propensity Score Estimation Performance\nSummarize the model and visualize the estimated propensity scores.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Summarize the fitted model\nsummary(lbc_net.fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\n Tr ~ X1 + X2 + X3 + X4 \nSample Size: 5000  | Number of Covariates: 4 \nTreated: 2466  | Control: 2534 \n\n--- Losses ---\nTotal Loss: 840.8040\n\n--- Local Balance (LSD) % ---\nMax LSD:   3.9247\nMean LSD:  0.4018\n\n--- Global Standardized Differences (GSD) % ---\nCovariate      Pre-GSD     Post-GSD \n-------------------------------- \nX1       -78.1284      -0.2568 \nX2        40.5772       0.2748 \nX3        -5.9774      -0.0084 \nX4        21.7461       0.0223 \n\n--- Treatment Effect Estimate ---\nATE: -3.3174  (SE: 0.4207)  95% CI: [-4.1419, -2.4928]\n```\n\n\n:::\n\n```{.r .cell-code}\n# Mirror histogram for covariate distribution balance\nmirror_hist(lbc_net.fit)\n```\n\n::: {.cell-output-display}\n![](example_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Calibration plot to assess model calibration\nplot_calib(lbc_net.fit)\n```\n\n::: {.cell-output-display}\n![](example_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\n## Evaluate Covariate Balance\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute local balance diagnostics\nlsd.fit <- lsd(lbc_net.fit)\n\n# Print and summarize local balance\nprint(lsd.fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSample Size: 5000  | Treated: 2466  | Control: 2534 \nEstimand: ATE (Average Treatment Effect) \n\n--- Local Balance (LSD) % ---\nMax LSD: 3.9246 \nMean LSD: 0.4018 \n\nKernel: \"gaussian\" \n\nUse summary(object) for a full model summary.\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(lsd.fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\n function (x, ...)  UseMethod(\"formula\") \nSample Size: 5000  | Number of Covariates: 4 \nTreated: 2466  | Control: 2534 \nEstimand: ATE (Average Treatment Effect) \n\n--- Local Balance (LSD) % ---\nMax LSD:   3.9246\nMean LSD:  0.4018\n\nCovariates   LSD % \n------------- \nX1    0.8687 \nX2    0.3959 \nX3    0.1678 \nX4    0.1749 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Plot local balance metrics\nplot(lsd.fit)\n```\n\n::: {.cell-output-display}\n![](example_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nFor a more detailed tutorial, visit our [Step-by-Step Tutorial](tutorial.qmd).\n\n\n\n\n\n\n\n",
    "supporting": [
      "example_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}