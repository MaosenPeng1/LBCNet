<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Estimate Propensity Scores Using LBC-Net — lbc_net • LBCNet</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate Propensity Scores Using LBC-Net — lbc_net"><meta name="description" content="`lbc_net` estimates propensity scores using the LBC-Net model,
a deep learning method designed to enhance covariate balance.
It integrates a Variational Autoencoder (VAE) with a customized
neural network to estimate treatment probabilities for causal inference.
When an outcome `Y` is supplied, `lbc_net` also computes inverse probability
weighted (IPW) estimates of the causal effect (ATE or ATT) and, when enabled,
corresponding influence-function–based standard errors and confidence intervals."><meta property="og:description" content="`lbc_net` estimates propensity scores using the LBC-Net model,
a deep learning method designed to enhance covariate balance.
It integrates a Variational Autoencoder (VAE) with a customized
neural network to estimate treatment probabilities for causal inference.
When an outcome `Y` is supplied, `lbc_net` also computes inverse probability
weighted (IPW) estimates of the causal effect (ATE or ATT) and, when enabled,
corresponding influence-function–based standard errors and confidence intervals."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">LBCNet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimate Propensity Scores Using LBC-Net</h1>

      <div class="d-none name"><code>lbc_net.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>`lbc_net` estimates propensity scores using the LBC-Net model,
a deep learning method designed to enhance covariate balance.
It integrates a Variational Autoencoder (VAE) with a customized
neural network to estimate treatment probabilities for causal inference.</p>
<p>When an outcome `Y` is supplied, `lbc_net` also computes inverse probability
weighted (IPW) estimates of the causal effect (ATE or ATT) and, when enabled,
corresponding influence-function–based standard errors and confidence intervals.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">lbc_net</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Z <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Tr <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ATE"</span>, <span class="st">"ATT"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>  K <span class="op">=</span> <span class="fl">99</span>,</span>
<span>  rho <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  na.action <span class="op">=</span> <span class="va">na.fail</span>,</span>
<span>  gpu <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  show_progress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  setup_lbcnet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>an optional data frame, list, or environment (or an object
coercible by `as.data.frame` to a data frame) containing the variables
specified in `formula`. If a variable is not found in `data`, it is taken
from `environment(formula)`, typically the environment from which
`lbc_net()` is called. If `formula` is not provided, `Z` (a matrix of
covariates) and `Tr` (a numeric treatment assignment vector) must be
explicitly supplied.</p></dd>


<dt id="arg-formula">formula<a class="anchor" aria-label="anchor" href="#arg-formula"></a></dt>
<dd><p>An object of class `"formula"` (or one that can be coerced to
that class), specifying a symbolic description of the model in the form
`Tr ~ X1 + X2 + ...`. If `formula` is provided, `Z` and `Tr` are extracted
from `data`. If omitted, `Z` and `Tr` must be supplied explicitly.</p></dd>


<dt id="arg-z">Z<a class="anchor" aria-label="anchor" href="#arg-z"></a></dt>
<dd><p>A numeric matrix or data frame of covariates. Required if `formula` is not provided.
Each row represents an observation, and each column represents a covariate.
If `formula` is used, `Z` is extracted from `data` automatically.</p></dd>


<dt id="arg-tr">Tr<a class="anchor" aria-label="anchor" href="#arg-tr"></a></dt>
<dd><p>A numeric vector representing treatment assignment (typically 0/1).
Required if `formula` is not provided. Must have the same number of rows
as `Z`. If `formula` is used, `Tr` is extracted from `data` automatically.</p></dd>


<dt id="arg-y">Y<a class="anchor" aria-label="anchor" href="#arg-y"></a></dt>
<dd><p>Optional numeric vector of observed outcomes. If provided, `lbc_net`
will, in addition to estimating propensity scores, compute inverse probability
weighted estimates of a causal estimand (e.g., ATE or ATT) using the fitted
LBC-Net model. `Y` can be continuous or binary; the IPW formula is the same,
only the interpretation differs.</p></dd>


<dt id="arg-estimand">estimand<a class="anchor" aria-label="anchor" href="#arg-estimand"></a></dt>
<dd><p>Character string specifying the target estimand when an outcome
`Y` is supplied. Available options are:</p><dl><dt>`"ATE"`</dt>
<dd><p>Average Treatment Effect. The frequency weight function
    \(\omega^{*}(p_i) = 1\) targets the combined population.</p></dd>

  <dt>`"ATT"`</dt>
<dd><p>Average Treatment Effect on the Treated. The frequency weight
    function \(\omega^{*}(p_i) = p_i\) upweights units that are likely to be treated.</p></dd>

  <dt>`"Y"`</dt>
<dd><p>Weighted mean outcome among the treated group, using IPW weights
    derived from the fitted propensity scores.</p></dd>


</dl><p>If `Y` is `NULL`, `estimand` is ignored and `lbc_net` only fits the propensity model.
See **Details** for more information on ATT, ATE, and their corresponding weighting schemes.</p></dd>


<dt id="arg-k">K<a class="anchor" aria-label="anchor" href="#arg-k"></a></dt>
<dd><p>an integer specifying the number of grid center points used to
compute kernel weights in the local neighborhood. These weights are
used to assess balance and calibration conditions. If specified, `ck`
is automatically computed as `k / (K + 1)`, where `k = 1, ..., K`.
The default is `99`, generating grid points from `0.01` to `0.99`.
See **Details** for more information on kernel weights.</p></dd>


<dt id="arg-rho">rho<a class="anchor" aria-label="anchor" href="#arg-rho"></a></dt>
<dd><p>a numeric value specifying the span used to determine the adaptive
bandwidth `h` when `h` is not provided. The span controls the proportion of
data included in the local neighborhood, ensuring a sufficient sample size
for accurate training. The choice of `rho` influences local balance assessment
and should be selected based on the data structure. While cross-validation
can be used to approximate an optimal span, user discretion is advised.
The default is `0.15`.</p></dd>


<dt id="arg-na-action">na.action<a class="anchor" aria-label="anchor" href="#arg-na-action"></a></dt>
<dd><p>A function to specify the action to be taken if NAs are found.
The default action is for the procedure to fail. An alternative is `na.omit`,
which leads to rejection of cases with missing values on any required variable.
(NOTE: If given, this argument must be named.)</p></dd>


<dt id="arg-gpu">gpu<a class="anchor" aria-label="anchor" href="#arg-gpu"></a></dt>
<dd><p>An integer specifying the GPU device ID for computation if CUDA is available.
If set to `0`, the function will attempt to use the default GPU. If CUDA is unavailable,
computations will automatically fall back to the CPU.</p></dd>


<dt id="arg-show-progress">show_progress<a class="anchor" aria-label="anchor" href="#arg-show-progress"></a></dt>
<dd><p>A logical value indicating whether to display a progress bar during training.
If `TRUE` (default), displays elapsed time, remaining time, loss values, and training speed
(iterations per second). This helps monitor training progress efficiently. Set to `FALSE` to disable the display.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional parameters for model tuning, including:</p><dl><dt>`ck`</dt>
<dd><p>a numeric vector of kernel center points. Values should be
  strictly between `0` and `1`. If `NULL`, `ck` is automatically computed
  using the default `K`. If provided, user-defined grid points should
  adhere to the constraint `0 &lt; ck &lt; 1`.</p></dd>


    <dt>`h`</dt>
<dd><p>A numeric vector of bandwidth values for kernel weighting. By
  default, an adaptive bandwidth is automatically computed via preliminary
  probabilities estimated using logistic regression (`glm`), given `ck`
  and the span parameter `rho`. If `NULL`, `h` is computed using
  <code><a href="span_bw.html">span_bw</a></code>.</p></dd>


    <dt>`kernel`</dt>
<dd><p>A character string specifying the kernel function used for local
  weighting. The default is `"gaussian"`. Available options include:</p><ul><li><p>`"gaussian"` (default): Ensures smooth weighting and continuity.</p></li>
<li><p>`"uniform"`: Assigns equal weight to all observations within a fixed bandwidth.</p></li>
<li><p>`"epanechnikov"`: Gives higher weight to observations closer to the kernel center.</p></li>
</ul><p>See **Details** for more information on kernel weighting and its role in local
  balance estimation.</p></dd>


    <dt>`seed`</dt>
<dd><p>An integer specifying the random seed for reproducibility in training the neural network.
  This seed is applied to PyTorch using `torch.manual_seed(seed)`, ensuring consistent results
  across runs when using stochastic optimization methods.</p></dd>


    <dt>`hidden_dim`</dt>
<dd><p>An integer specifying the number of hidden units in the LBC-Net model.
  A rule of thumb is to set this as two to three times the number of covariates,
  but it should be significantly smaller than the sample size to prevent overfitting.
  Default is `100`.</p></dd>


    <dt>`num_hidden_layers`</dt>
<dd><p>An integer specifying the number of hidden layers in the LBC-Net model.
  Default is `1`, which results in a three-layer network overall (input layer, one hidden layer, and output layer).</p></dd>


    <dt>`vae_epochs`</dt>
<dd><p>An integer specifying the number of training epochs for the Variational Autoencoder (VAE).
  This determines how long the VAE component of the model is trained before being used in LBC-Net.
  Default is `250`.</p></dd>


    <dt>`vae_lr`</dt>
<dd><p>A numeric value specifying the learning rate for training the VAE using the Adam optimizer.
  Controls how quickly the model updates its parameters during training. Default is `0.01`.</p></dd>


    <dt>`max_epochs`</dt>
<dd><p>An integer specifying the maximum number of training epochs for LBC-Net.
  Early stopping is applied based on `lsd_threshold` to prevent unnecessary training.
  Default is `5000`.</p></dd>


    <dt>`lr`</dt>
<dd><p>A numeric value specifying the initial learning rate for LBC-Net training using the Adam optimizer.
  The learning rate controls how much the model updates during each training step.
  Default is `0.05`.</p></dd>


    <dt>`weight_decay`</dt>
<dd><p>A numeric value specifying the regularization parameter in the Adam optimizer for LBC-Net.
  Helps prevent overfitting by penalizing large weights in the model.
  Default is `1e-5`.</p></dd>


    <dt>`balance_lambda`</dt>
<dd><p>A numeric value controlling the relative contributions of the local balance loss (\(Q_1\))
  and calibration loss (\(Q_2\)) in the objective function, where the total loss is defined as
  \(Q = Q_1 + \lambda Q_2\). Default is `1.0`.</p></dd>


    <dt>`epsilon`</dt>
<dd><p>A small numeric value controlling the lower and upper bounds of the
  estimated propensity scores. The default is `0.001`, ensuring scores remain within
  \([\epsilon, 1 - \epsilon]\) for numerical stability, particularly in cases of
  poor overlap. Setting `epsilon = 0` reverts to the standard logit link function.
  See **Details** for more on its role in model stabilization.</p></dd>


    <dt>`lsd_threshold`</dt>
<dd><p>A numeric value defining the stopping criterion based on the Local Standardized mean Difference (LSD).
  Training stops when the rolling average of the maximum local balance falls below this threshold.
  The default `lsd_threshold = 2` balances efficiency and precision. In cases of poor overlap or small
  sample sizes, a more relaxed threshold (e.g., `5%` or `10%`) may be used to allow more flexibility in training.</p></dd>


    <dt>`rolling_window`</dt>
<dd><p>An integer specifying the number of recent epochs used to compute the rolling average of
  the maximum local balance. Default is `5`. The early stopping mechanism is triggered when the rolling average
  of the maximum LSD over the most recent `rolling_window` epochs falls below `lsd_threshold`. Specifically,
  at every 200-epoch step, the maximum local balance is calculated, and a rolling average over the last
  `rolling_window` steps is updated. Training halts when this rolling average drops below `lsd_threshold`,
  or when the predefined maximum epochs is reached, ensuring sufficient learning capacity.</p></dd>


</dl></dd>


<dt id="arg-setup-lbcnet-args">setup_lbcnet_args<a class="anchor" aria-label="anchor" href="#arg-setup-lbcnet-args"></a></dt>
<dd><p>List. Optional arguments passed to <code><a href="setup_lbcnet.html">setup_lbcnet</a></code> for configuring the Python environment.
If Python is not set up, `setup_lbcnet()` is automatically called using these parameters.
Default is `list(envname = "r-lbcnet", create_if_missing = TRUE)`, meaning it will attempt to use the virtual environment `"r-lbcnet"`
and create it if missing.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An object of class `"lbc_net"`, containing:</p><ul><li><p>`fitted.values`: Estimated propensity scores.</p></li>
<li><p>`weights`: Inverse probability weights (IPW).</p></li>
</ul><p>Other model components (e.g., `losses`, `parameters`, `Z`, `Tr`) are accessible via `$`
or the recommended <code><a href="getLBC.lbc_net.html">getLBC</a></code> function. While direct access (e.g., `fit$fitted.values`)
is possible, using `getLBC(fit, "fitted.values")` is recommended for stability and future-proofing.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function optimizes the objective function \(Q(\theta)\) using a
feed-forward neural network with batch normalization after each layer.
Rectified Linear Unit (ReLU) activations are used in hidden layers, while
the output layer employs a modified sigmoid activation to ensure propensity
scores remain bounded between \(\epsilon\) and \(1-\epsilon\):</p>
<p>$$
p(\mathbf{Z}) = \epsilon + (1 - 2\epsilon)
\frac{\exp(S(\mathbf{Z}; \theta))}{1 + \exp(S(\mathbf{Z}; \theta))}
$$</p>
<p>In well-overlapping distributions, \(\epsilon = 0\) (logit link function)
is effective, while for poor overlap, \(\epsilon = 0.001\) stabilizes computation
by preventing extreme probabilities (0 or 1). The default \(\epsilon = 0.001\)
works well in most cases.</p>
<p>If categorical covariates with more than two levels are included in `formula` or `Z`,
users must manually convert them into dummy (one-hot encoded) variables before fitting the model.
This can be done as follows:</p>
<div class="sourceCode"><pre><code><span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">cate</span><span class="op">)</span></span>
<span><span class="va">dummy_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">cate</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">dummy_vars</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>

<p><strong>Optimization Process</strong>:
The model is trained using Adaptive Moment Estimation (ADAM) optimization.
Given the complexity of the objective function, a pre-training phase
using a Variational Autoencoder (VAE) is incorporated to enhance
feature representation. After pre-training, the encoder weights are transferred
to initialize the LBC-Net. This initialization improves training stability
and propensity score estimation.</p>
<p><strong>Kernel Weighting &amp; Local Inverse Probability Weights (IPW)</strong>:
To weigh observations in local neighborhoods, we use kernel smoothing to
define local balance weights. The default choice in this package is the
Gaussian kernel due to its smoothness and continuity, but users may
specify alternative kernels.</p>
<p>The general form of the kernel weighting function is:
$$\omega(c_k, x) = h_k^{-1} K\left( \frac{c_k - x}{h_k} \right)$$
where \(h_k\) is the location-specific bandwidth, and \(K(x)\)
is the kernel function. The default Gaussian kernel is given by:
$$K(x) = (2\pi)^{-1/2} \exp(-x^2/2)$$</p>
<p>Alternative Kernel Choices:
Users can modify the kernel function for different weighting schemes:</p><ul><li><p>Uniform Kernel:
         $$K(x) = 0.5 \times \mathbf{1}(|x| \leq 1)$$</p></li>
<li><p>Epanechnikov Kernel:
         $$K(x) = 0.75 (1 - x^2) \mathbf{1}(|x| \leq 1)$$</p></li>
</ul><p>The Local Inverse Probability Weight (LIPW) at each local grid center \(c_k\) is:
$$
W_k(p_i) = \frac{ \omega(c_k, p_i)\omega^*(p_i) }{ T_i p_i + (1 - T_i)(1 - p_i) }, \quad i = 1, 2, ..., N.
$$</p>
<p>The frequency weight function \(\omega^{*}(p_i)\) determines the target population:
setting \(\omega^{*}(p_i) = 1\) yields the Average Treatment Effect (ATE), while
choosing \(\omega^{*}(p_i) = p_i\) results in the Average Treatment Effect on the Treated (ATT).</p>
<p><strong>Training Considerations &amp; Tuning</strong>:</p>
<p>- Poor Overlap Situations: If groups have poor overlap
  (see <code><a href="mirror_hist.html">mirror_hist</a></code>), achieving the minimum local balance may be difficult.
  In such cases, relax `lsd_threshold` and increase `max_epochs`.</p>
<p>- Tuning Neural Network Parameters: The local balance (`LSD`) and loss
  from <code><a href="summary.lbc_net.html">summary</a></code> can guide tuning. However, the default values
  generally work well in most cases.</p>
<p>- The LSD metric is used to evaluate local balance and guide hyperparameter tuning.</p>
<p>- During training, the model tracks LSD values to determine convergence.</p>
<p>These can be retrieved using: <code><a href="getLBC.html">getLBC</a></code>(object, "max_lsd"):
    Returns the maximum LSD at last epoch training; <code><a href="getLBC.html">getLBC</a></code>(object, "mean_lsd"):
    Returns the mean LSD.</p>
<p>- For final evaluation:</p><ul><li><p><code><a href="lsd.html">lsd</a></code>(object):
         Computes the final LSD values based on the fitted model;</p></li>
<li><p><code><a href="plot.lsd.html">plot.lsd</a></code>(object):
         Generates visualizations for LSD values across covariates;</p></li>
<li><p><code><a href="plot_calib.html">plot_calib</a></code>(object):
         Assesses the local calibration for estimated propensity scores.</p></li>
<li><p><code><a href="mirror_hist.html">mirror_hist</a></code>(object):
         Mirror histogram for propensity score distribution between groups.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="lbc_net-class.html">lbc_net-class</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Set seed for reproducibility</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123456</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define sample size</span></span></span>
<span class="r-in"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate true covariates from a multivariate normal distribution</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"MASS"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">n</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate propensity scores (true model)</span></span></span>
<span class="r-in"><span><span class="va">prop</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span></span></span>
<span class="r-in"><span>                      <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Assign treatment based on propensity scores</span></span></span>
<span class="r-in"><span><span class="va">Tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prop</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate continuous outcome (correctly specified model)</span></span></span>
<span class="r-in"><span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fl">210</span> <span class="op">+</span> <span class="fl">27.4</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span></span></span>
<span class="r-in"><span>     <span class="fl">13.7</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Estimate propensity scores with a misspecified model</span></span></span>
<span class="r-in"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>           <span class="va">Z</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>           <span class="op">(</span><span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">25</span> <span class="op">+</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span>,</span></span>
<span class="r-in"><span>           <span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">Z</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fl">20</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Combine data into a data frame</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Tr</span>, <span class="va">X</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>, <span class="st">"Tr"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># --- Fit the LBC-Net Model (propensity only) ---</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Option 1: Using formula input (PS + diagnostics only)</span></span></span>
<span class="r-in"><span><span class="va">model_ps</span> <span class="op">&lt;-</span> <span class="fu">lbc_net</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, formula <span class="op">=</span> <span class="va">Tr</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Option 2: Directly using Z and Tr</span></span></span>
<span class="r-in"><span><span class="va">model_ps2</span> <span class="op">&lt;-</span> <span class="fu">lbc_net</span><span class="op">(</span>Z <span class="op">=</span> <span class="va">X</span>, Tr <span class="op">=</span> <span class="va">Tr</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># --- Fit the LBC-Net Model and estimate ATE in one step ---</span></span></span>
<span class="r-in"><span><span class="va">model_ate</span> <span class="op">&lt;-</span> <span class="fu">lbc_net</span><span class="op">(</span></span></span>
<span class="r-in"><span>  data     <span class="op">=</span> <span class="va">data</span>,</span></span>
<span class="r-in"><span>  formula  <span class="op">=</span> <span class="va">Tr</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span>,</span></span>
<span class="r-in"><span>  Y        <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>,</span></span>
<span class="r-in"><span>  estimand <span class="op">=</span> <span class="st">"ATE"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model_ate</span><span class="op">)</span>          <span class="co"># basic print</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_ate</span><span class="op">)</span>        <span class="co"># may show effect and PS summaries</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract effect and SE</span></span></span>
<span class="r-in"><span><span class="fu"><a href="getLBC.html">getLBC</a></span><span class="op">(</span><span class="va">model_ate</span>, <span class="st">"effect"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="getLBC.html">getLBC</a></span><span class="op">(</span><span class="va">model_ate</span>, <span class="st">"se"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># --- Performance Evaluation ---</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Mirror histogram of propensity scores</span></span></span>
<span class="r-in"><span><span class="fu"><a href="mirror_hist.html">mirror_hist</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calibration plot</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_calib.html">plot_calib</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute and plot the LSD metric</span></span></span>
<span class="r-in"><span><span class="va">lsd.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="lsd.html">lsd</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lsd.fit</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Maosen Peng, Yan Li, Chong Wu, Liang Li.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

